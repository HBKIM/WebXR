<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>갤럭시 S9 WebXR 테스트</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #000;
            touch-action: none;
        }
        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        #girl-image {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 70px;
            height: 70px;
            z-index: 1000;
            border: 2px solid #fff;
            border-radius: 50%;
        }
        #enterVR {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 250px;
        }
        #info {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 12px 15px;
            border-radius: 12px;
            text-align: center;
            z-index: 1000;
            width: 85%;
            max-width: 300px;
            font-size: 14px;
            line-height: 1.4;
        }
        #status {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 12px;
        }
    </style>
    <!-- Three.js 최신 버전 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <!-- WebXRManager 포함 버전 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/WebGL.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/WebXR.js"></script>
</head>
<body>
    <div id="container">
        <img id="girl-image" src="girl.png" alt="Girl">
        <div id="status">초기화 중...</div>
        <div id="info">갤럭시 S9 최적화 버전<br>VR 버튼을 눌러 시작하세요</div>
        <button id="enterVR">VR 모드 시작</button>
    </div>

    <script>
        // 상태 업데이트 함수
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }

        // WebXR 지원 체크
        async function checkXRSupport() {
            if (!navigator.xr) {
                updateStatus("WebXR 미지원 브라우저");
                return false;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                return supported;
            } catch (error) {
                console.error("XR 지원 확인 오류:", error);
                return false;
            }
        }

        // VR 버튼 생성 (호환성 처리)
        function createVRButton(renderer) {
            if (typeof THREE.VRButton === 'undefined') {
                const button = document.createElement('button');
                button.id = 'fallback-vr-button';
                button.style.display = 'none';
                button.textContent = 'Enter VR';
                document.body.appendChild(button);
                return button;
            }
            return THREE.VRButton.createButton(renderer);
        }

        // 메인 초기화 함수
        async function init() {
            updateStatus("Three.js 로드 중...");
            
            try {
                // Three.js 장면 생성
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
                camera.position.set(0, 1.6, 0);
                
                // WebGL 렌더러 설정
                const renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                document.body.appendChild(renderer.domElement);

                // 정육면체 생성 (큰 사이즈)
                const geometry = new THREE.BoxGeometry(15, 15, 15);
                const materials = [
                    new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.BackSide }),
                    new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.BackSide }),
                    new THREE.MeshBasicMaterial({ color: 0x0000ff, side: THREE.BackSide }),
                    new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.BackSide }),
                    new THREE.MeshBasicMaterial({ color: 0xff00ff, side: THREE.BackSide }),
                    new THREE.MeshBasicMaterial({ color: 0x00ffff, side: THREE.BackSide })
                ];
                const cube = new THREE.Mesh(geometry, materials);
                scene.add(cube);

                // VR 버튼 생성 (호환성 처리)
                updateStatus("VR 버튼 생성 중...");
                const vrButton = createVRButton(renderer);
                vrButton.style.display = 'none';
                document.body.appendChild(vrButton);

                // VR 버튼 이벤트 처리
                document.getElementById('enterVR').addEventListener('click', function() {
                    updateStatus("VR 모드 시작 시도...");
                    vrButton.click();
                });

                // XR 세션 이벤트 처리
                renderer.xr.addEventListener('sessionstart', () => {
                    updateStatus("VR 모드 활성화됨");
                    document.getElementById('info').textContent = "VR 모드가 활성화되었습니다!\n기기를 움직여 보세요.";
                    document.getElementById('enterVR').textContent = "VR 모드 종료";
                });

                renderer.xr.addEventListener('sessionend', () => {
                    updateStatus("VR 모드 종료됨");
                    document.getElementById('info').textContent = "VR 모드가 종료되었습니다.\n버튼을 눌러 다시 시작하세요.";
                    document.getElementById('enterVR').textContent = "VR 모드 시작";
                });

                // 창 크기 조정
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });

                // 애니메이션 루프 시작
                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                });

                updateStatus("준비 완료 - VR 버튼을 눌러주세요");

            } catch (error) {
                console.error("초기화 오류:", error);
                updateStatus("초기화 실패: " + error.message);
                document.getElementById('info').innerHTML = 
                    "오류 발생: " + error.message + "<br><br>" +
                    "갤럭시 S9 사용자:<br>" +
                    "1. Chrome 최신 버전 사용<br>" +
                    "2. chrome://flags 에서 WebXR 활성화<br>" +
                    "3. 기기 재시작 후 시도";
            }
        }

        // 페이지 로드 시 시작
        window.addEventListener('load', async () => {
            updateStatus("시스템 확인 중...");
            
            const isSupported = await checkXRSupport();
            if (!isSupported) {
                document.getElementById('info').innerHTML = 
                    "이 브라우저는 WebXR을 지원하지 않습니다.<br><br>" +
                    "해결 방법:<br>" +
                    "1. Chrome 최신 버전 설치<br>" +
                    "2. chrome://flags 에서 'WebXR' 검색 후 활성화<br>" +
                    "3. 기기 재시작";
                document.getElementById('enterVR').style.display = 'none';
                return;
            }

            // 3초 후 초기화 (리소스 완전 로드 보장)
            setTimeout(init, 3000);
        });
    </script>
</body>
</html>
